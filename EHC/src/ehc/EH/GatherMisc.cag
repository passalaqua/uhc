%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%% Gathering misc bits of info
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

%%[(92 hmtyinfer)
ATTR AGItf Expr AllDecl [ | | gathHiddenExports USE {`Seq.union`} {Seq.empty}: {Seq.Seq (HsName,IdOccKind)} ]

SEM Expr
  | Let         lhs         .   gathHiddenExports   =   Seq.fromList [ (dictNm,IdOcc_Val) | (_,dictNm,_,_,_) <- @generInstInfoL ]
                                                        `Seq.union`
                                                        @decls.gathHiddenExports
                                                        `Seq.union`
                                                        @body.gathHiddenExports

SEM Decl
  | Class       lhs         .   gathHiddenExports   =   Seq.fromList [ (dflt,IdOcc_Val) | (_,dflt) <- @generDerivs ]
%%]

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%% Gathering BindingInfo relevant to any subsequent code generation
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

%%[(8 codegen)
ATTR AGItf Expr AllDecl [ | | gathBindingMp USE {`lamMpUnionBindAspMp`} {Map.empty}: BindingMp ]

%%]

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%% Gathering Fusion related BindingInfo (probably better in separate file)
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

%%[(93 codegen)
SEM Decl
  | FusionDecl  lhs         .   gathBindingMp           =   Map.singleton
                                                            @fuseNm
                                                            (emptyBindingInfo {bindinginfoAspMp = Map.singleton acbaspkeyFusionRole (BindingInfoAsp_FusionRole FusionRole_Fuse)})
  | FusionConv  lhs         .   gathBindingMp           =   Map.fromList
                                                            [ ( @conNm, emptyBindingInfo {bindinginfoAspMp = Map.singleton acbaspkeyFusionRole (BindingInfoAsp_FusionRole FusionRole_BuildLeft)} )
                                                            , ( @absNm, emptyBindingInfo {bindinginfoAspMp = Map.singleton acbaspkeyFusionRole (BindingInfoAsp_FusionRole FusionRole_BuildRight)} )
                                                            ]
%%]
